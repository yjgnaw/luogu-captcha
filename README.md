# Luogu Captcha Recognition with CRNN

A PyTorch-based CRNN (Convolutional Recurrent Neural Network) for recognizing 35×90 pixel Luogu captchas. The model uses CTC (Connectionist Temporal Classification) loss to train on 4-character alphanumeric captcha images.

## Features

- **CRNN Architecture**: Compact CNN-to-BiLSTM pipeline optimized for 35×90 captcha images
- **CTC Loss**: Handles variable-length sequences and character alignment automatically
- **Data Augmentation**: Moderate augmentation (color jitter, affine transforms) for regularization
- **Live Prediction**: Fetch and predict captchas directly from the Luogu endpoint
- **Checkpoint Resume**: Train for multiple epochs with automatic best-model saving and resuming
- **Pytest Coverage**: Unit tests for model forward pass, decoding, and utilities

## Project Structure

```
luogu-captcha/
├── src/
│   ├── __init__.py
│   ├── config.py           # Shared constants (charset, blank index, num classes)
│   └── model.py            # CRNN model, CRNNConfig, utility functions
├── scripts/
│   ├── smoke_model.py      # Quick sanity check on random input
│   ├── train.py            # Full training loop with resume support
│   ├── predict.py          # Fetch and predict live captchas with matplotlib
│   └── README.md
├── tests/
│   └── test_model.py       # Pytest suite for model validation
├── captchas/
│   ├── labels.csv          # Ground-truth labels (generated by generate.php)
│   └── captcha_*.jpg       # Training images (generated by generate.php, e.g., 50k)
├── checkpoints/
│   ├── crnn.pt             # Latest model checkpoint (saved every epoch)
│   └── crnn_best.pt        # Best model checkpoint (saved when val_acc improves)
├── requirements.txt        # Python dependencies
├── generate.php            # PHP script to generate synthetic captchas
├── composer.json           # Composer config (for Gregwar captcha library)
└── README.md               # This file
```

## Installation

1. **Clone or set up the repository:**

   ```bash
   cd luogu-captcha
   ```

2. **Create and activate a virtual environment (recommended):**

   ```bash
   python -m venv venv
   source venv/Scripts/activate  # Windows
   # or
   source venv/bin/activate      # Linux/macOS
   ```

3. **Install Python dependencies:**

   ```bash
   pip install -r requirements.txt
   ```

### Generate Training Data

The project includes a PHP script to synthetically generate Luogu-style captchas.

#### Prerequisites

- **PHP** 7.0+ ([download](https://www.php.net/downloads))
- **Composer** ([download](https://getcomposer.org/))

#### Setup & Generation

1. **Install PHP dependencies:**

   ```bash
   composer install
   ```

   This downloads the [Gregwar/Captcha](https://github.com/Gregwar/Captcha) library.

2. **Generate captchas:**

   ```bash
   php generate.php [count]
   ```

   Examples:

   ```bash
   # Generate 10,000 captchas (default)
   php generate.php
   
   # Generate 50,000 captchas
   php generate.php 50000
   
   # Generate 100,000 captchas
   php generate.php 100000
   ```

#### Output

The script creates:

- **`captchas/`** folder with JPEG images (e.g., `captcha_00001.jpg`, `captcha_00002.jpg`, ...)
- **`captchas/labels.csv`** with format:

  ```
  captcha_00001.jpg,3K7F
  captcha_00002.jpg,9ABC
  ...
  ```

#### Captcha Details

- **Size**: 90×35 pixels
- **Characters**: 4 per image
- **Charset**: `123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnpqrstuvwxyz`
  - 9 digits (0 excluded for clarity)
  - 26 uppercase letters
  - 25 lowercase letters (o excluded to avoid confusion with 0)
- **Total unique combinations**: ~60⁴ ≈ 13M possible captchas

#### Customization

To modify the generator, edit `generate.php`:

- Change `$builder->build(90, 35)` for different dimensions
- Modify `$charset` in `FourCharPhraseBuilder` for different characters
- Pass a count argument to generate more/fewer images (see examples above)

## Usage

### Model Overview

The CRNN expects input tensors of shape `(batch, 3, 35, 90)` normalized to `[0, 1]`. It outputs log-probabilities of shape `(T≈22, batch, NUM_CLASSES)` suitable for CTC loss.

**Character Set**: `123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnpqrstuvwxyz` (60 characters + 1 CTC blank)

### 1. Smoke Test

Verify the model runs on random input:

```bash
python scripts/smoke_model.py
```

Expected output:

```
Log prob shape: (22, 2, 61) (T, B, C=61)
Sample 0: '...' (len=4)
Sample 1: '...' (len=4)
```

### 2. Training

Train from scratch:

```bash
python scripts/train.py --epochs 30 --batch-size 128 --weight-decay 1e-4
```

Resume from best checkpoint:

```bash
python scripts/train.py --epochs 10 --batch-size 128 --resume checkpoints/crnn_best.pt
```

**Checkpoint Behavior:**

- `crnn.pt` (latest): Saved every epoch with current best val accuracy tracking
- `crnn_best.pt` (best): Saved only when validation accuracy improves

For resuming, use `crnn_best.pt` to continue from the highest validation point.

**Key Arguments:**

- `--data-dir`: Path to captchas folder (default: `captchas/`)
- `--labels-csv`: Path to labels CSV (default: `captchas/labels.csv`)
- `--batch-size`: Batch size (default: 128)
- `--epochs`: Number of epochs to train (default: 5)
- `--lr`: Learning rate (default: 1e-3)
- `--weight-decay`: L2 regularization (default: 1e-4)
- `--device`: `cuda` or `cpu` (default: auto-detect)
- `--val-split`: Train/val split ratio (default: 0.1)
- `--resume`: Path to checkpoint to resume from
- `--seed`: Random seed (default: 42)

### 3. Live Prediction

Fetch a captcha from Luogu and visualize prediction:

```bash
python scripts/predict.py
```

Multiple predictions with matplotlib display:

```bash
python scripts/predict.py --count 5
```

**Key Arguments:**

- `--ckpt`: Path to checkpoint (default: `checkpoints/crnn.pt`)
- `--device`: Device to run on (default: auto-detect)
- `--count`: Number of captchas to fetch (default: 1)

### 4. Testing

Run pytest suite:

```bash
pytest -q
```

Expected output:

```
4 passed in 2.49s
```

## Model Architecture

### CNN Backbone

- Conv2d(3, 64) → BatchNorm → ReLU → MaxPool(2×2)
- Conv2d(64, 128) → BatchNorm → ReLU → MaxPool(2×2)
- Conv2d(128, 256) → BatchNorm → ReLU
- Conv2d(256, 256) → BatchNorm → ReLU → MaxPool(2×1)
- Conv2d(256, 512) → BatchNorm → ReLU → MaxPool(2×1)
- Conv2d(512, 512) → BatchNorm → ReLU

Final feature map: `(batch, 512, 2, 22)`

### RNN & Classifier

- BiLSTM: input 1024 (512×2), hidden 256, 2 layers
- Linear classifier: 512 → 61 (charset + blank)
- Log-softmax for CTC loss

### Regularization

- **Data Augmentation** (training only):
  - Color jitter: brightness, contrast, saturation ±30%
  - Affine: ±8° rotation, ±3% translate, ±8% shear
  - Gaussian blur: σ ∈ [0.1, 0.5]
- **LSTM Dropout**: 0.4 (applied between BiLSTM layers)
- **Weight Decay**: L2 regularization (λ=1e-4)
- **Deterministic Split**: Fixed train/val split with seeded shuffle

## Training Results

With 50k captcha dataset (90% train, 10% val), stronger regularization (LSTM dropout 0.4, aggressive augmentation), and batch size 128:

```
Epoch 30/30
  train_loss=0.0824 train_acc=0.9512 val_loss=0.2156 val_acc=0.8640
  Saved latest model to checkpoints/crnn.pt
```

Best validation accuracy: **86.4%+** (exact 4-character match) with improved generalization over 10k dataset baseline.

## API Reference

### `src.config`

- `CHARSET`: Character set string
- `BLANK_INDEX`: Index reserved for CTC blank
- `NUM_CLASSES`: Total classes (charset + blank)

### `src.model.CRNN`

```python
model = CRNN(config=CRNNConfig(img_channels=3, hidden_size=256, num_lstm_layers=2))
log_probs = model(x)  # (T, B, C) log-probabilities
```

### `src.model` Utilities

- `text_to_labels(text, charset, device)`: String → label tensor
- `labels_to_text(labels, charset, blank_index)`: Labels → string
- `ctc_greedy_decode(log_probs, charset, blank_index)`: Greedy CTC decode
- `CRNN.output_lengths(input_widths)`: Compute output sequence lengths

## Dependencies

- **PyTorch**: `torch>=2.2`, `torchvision>=0.17`
- **Data**: `pandas>=2.0`, `pillow>=10.0`
- **Training**: `tqdm>=4.65`
- **Testing**: `pytest>=7.0`
- **Inference**: `requests>=2.28`, `matplotlib>=3.5`

## Tips

1. **Memory Issues**: Reduce `--batch-size` or use `--device cpu` if VRAM is limited.
2. **Slow Training**: Enable `--num-workers` for faster data loading (default: 2).
3. **Better Accuracy**: Generate more synthetic captchas or collect real ones; increase `--epochs`.
4. **Reproducibility**: Use `--seed` to set random state across all operations.

## License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.

The PHP captcha generator uses [Gregwar/Captcha](https://github.com/Gregwar/Captcha) (also MIT licensed).

## References

- [CRNN Architecture Paper](https://arxiv.org/abs/1507.05717)
- [CTC Loss](https://distill.pub/2017/ctc/)
- PyTorch Documentation
